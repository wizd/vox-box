services:
  # 语音识别 (Speech-to-Text) - 支持中文
  # faster-whisper-large-v3: 最佳多语言模型，中文识别效果优秀
  vox-stt:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: vox-stt
    ports:
      - "8080:80"
    volumes:
      - vox-stt-data:/data
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    command:
      - "--host"
      - "0.0.0.0"
      - "--port"
      - "80"
      - "--device"
      - "cuda:0"
      - "--huggingface-repo-id"
      - "Systran/faster-whisper-large-v3"
      - "--data-dir"
      - "/data"
    restart: unless-stopped

  # 语音合成 (Text-to-Speech) - 支持中文
  # CosyVoice-300M-SFT: 高质量中文语音合成模型（已验证 Linux 支持）
  vox-tts:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: vox-tts
    ports:
      - "8082:80"
    volumes:
      - vox-tts-data:/data
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    command:
      - "--host"
      - "0.0.0.0"
      - "--port"
      - "80"
      - "--device"
      - "cuda:0"
      - "--huggingface-repo-id"
      - "FunAudioLLM/CosyVoice-300M-SFT"
      - "--data-dir"
      - "/data"
    restart: unless-stopped

  # Qwen3-TTS - 高性能低延迟中文语音合成 (vLLM-Omni)
  # 独立服务，与 CosyVoice 并存，API 兼容 OpenAI /v1/audio/speech
  qwen3-tts:
    image: vllm/vllm-omni:v0.14.0
    container_name: qwen3-tts
    ports:
      - "8083:8000"
    volumes:
      - qwen3-tts-cache:/root/.cache/huggingface
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    ipc: host
    entrypoint: ["vllm", "serve", "--omni"]
    command:
      - "Qwen/Qwen3-TTS-12Hz-1.7B-CustomVoice"
      - "--host"
      - "0.0.0.0"
      - "--port"
      - "8000"
      - "--gpu-memory-utilization"
      - "0.5"
      - "--trust-remote-code"
      - "--enforce-eager"
    restart: unless-stopped

  # CosyVoice3 - 高性能流式中文语音合成 (Fun-CosyVoice3-0.5B)
  # OpenAI 兼容 API, 流式 PCM, ~1.2s TTFB
  # 基于 neosun/cosyvoice:v3.4.0 升级 PyTorch 以支持 RTX 5090 Blackwell
  cosyvoice3:
    build:
      context: .
      dockerfile: Dockerfile.cosyvoice3
    container_name: cosyvoice3
    ports:
      - "8188:8188"
    volumes:
      - cosyvoice3-voices:/data/voices
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ["0"]
              capabilities: [gpu]
    restart: unless-stopped

volumes:
  vox-stt-data:
  vox-tts-data:
  qwen3-tts-cache:
  cosyvoice3-voices:
